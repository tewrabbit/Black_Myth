# 🎮 黑神话：悟空 (Black Myth: Wukong) - 深度机制还原与技术设计文档

> **文档版本**: v2.0
> **适用框架**: Cocos2d-x v4.0 (C++)
> **最后更新**: 2025-11-25

---

## 1. 📊 基类状态机与数值系统 (Base Stats & Architecture)

在原作中，战斗资源管理是核心体验。我们需要在 `GameCore/Character` 基类中构建以下系统。

### 1.1 核心属性定义与计算公式

| 属性名称 | 变量名 | 类型 | 原作机制说明 | **技术实现公式 / 逻辑** |
| :--- | :--- | :--- | :--- | :--- |
| **生命值** | `_hp` | float | 归零死亡。 | `CurrentHP = clamp(CurrentHP - FinalDamage, 0, MaxHP)` |
| **法力值** | `_mp` | float | 释放奇术消耗。 | 只有特定道具或打坐可恢复。 |
| **气力 (Stamina)** | `_stamina` | float | **节奏核心**。奔跑/闪避/攻击均消耗。 | 恢复逻辑：`if (state != RUN && state != ATTACK) _stamina += _recoveryRate * dt;` |
| **棍势 (Focus)** | `_focus` | int | **核心战斗资源**。轻棍命中或完美闪避积累(0-300)。 | `MaxFocusPoints = floor(_focus / 100);` // 界面显示1-3颗豆 |
| **攻击力** | `_attack` | float | 基础伤害值。 | `BaseDamage = _attack * SkillMultiplier;` |
| **防御力** | `_defense` | float | 减伤百分比。 | `FinalDamage = BaseDamage * (1.0f - _defense / (_defense + 100.0f));` |
| **韧性 (Poise)** | `_poise` | float | **隐藏属性**。被削减到0时产生大硬直。 | `_poise -= HitImpact; if (_poise <= 0) changeState(STAGGER);` |

### 1.2 状态机扩展 (State Machine)

为了支持复杂的动作交互，我们需要在基础状态上补充以下特殊状态：

* **`PRE_ATTACK` (前摇)**: 动作刚开始，尚未产生攻击判定。*（此时可被闪避取消）*
* **`ACTIVE_ATTACK` (判定)**: 攻击生效，Hitbox 激活。
* **`RECOVERY` (后摇)**: 攻击结束但无法移动。*（通常可用闪避取消硬直，即 "Cancel" 机制）*
* **`PERFECT_DODGE` (完美闪避)**: 触发慢动作特效，回复棍势。

---

## 2. 🐒 悟空：动作模块深度还原 (Wukong Mechanics)

### 2.1 基础移动与身法
* **移动 (Walk/Run)**: 推动摇杆/WASD移动。
* **疾奔 (Sprint)**: 按住闪避键移动，**持续消耗气力**。
* **跳跃 (Jump)**: 基础跳跃，支持空中轻/重棍。
* **翻滚/闪避 (Dodge)**:
    * **普通闪避**: 消耗气力，拥有约 0.2s 无敌帧。
    * **完美闪避**: 检测逻辑：`if (EnemyHitbox.intersects(Player) && PlayerState == DODGE_START)`。触发后：`GameSpeed = 0.1` (慢动作), `_focus += 50`。

### 2.2 棍法系统 (核心战斗)

**A. 轻棍 (Light Attack)**
* **5段连招**: 一套固定的动作库。
* **输入缓存机制 (Input Buffer)**:
    * **原理**: 防止玩家狂按按键导致操作丢失或动作僵硬。
    * **实现**: 在当前动作播放的最后 0.3秒 内，如果检测到按键，将指令存入队列。当前动作结束时，自动从队列取出并执行下一个动作。

**B. 重棍 (Heavy Attack)**
* **蓄力机制**: 按住重击键进入 `CHARGE` 状态，每 0.5秒 增加一层棍势（最高3层）。松开释放对应层数的强力一击。
* **切手技 (Varied Combo / See-Through)**:
    * **逻辑**: 在轻棍连招中（例如轻1、轻2后）按下重棍。
    * **效果**: 消耗 1 豆，触发带霸体（Super Armor）的“破棍式”，可抵消敌人攻击并反击。

**C. 棍势架势 (Stances) - (建议项目选做一种)**
* **劈棍 (Smash)**: 默认架势，跑动中可蓄力，灵活性高。

### 2.3 奇术与技能 (Spells)
* **定身法**: 锁定敌人，将其 `TimeScale` 设为 0 或切换至 `FROZEN` 状态。持续 3 秒。
* **聚形散气 (隐身)**: 原地生成一个 `Decoy` (假身) 吸引仇恨，真身隐形加速。下一次攻击必定暴击。
* **变身 (Transformation)**: 暂时切换玩家控制的角色对象为“广智（刀狼）”，拥有独立血条和火属性攻击模组。

---

## 3. 👹 敌人配置与 AI 行为树 (Enemy & AI)

为了体现策略性，我们将敌人 AI 设计为 **行为树 (Behavior Tree)** 逻辑，而非简单的 If-Else。

### 3.1 小怪配置 (分工明确)

1.  **小怪 1：巡逻刀狼 (近战)**
    * **行为**: 巡逻 -> 索敌 -> 接近 -> **轻攻击**。
    * **受击**: 低韧性，被轻棍打中即产生硬直（后仰）。
2.  **小怪 2：骷髅弓手 (远程)**
    * **行为**: 远离主角 -> 瞄准 -> **发射投射物**。
    * **AI 逻辑**: `if (distance < safe_zone) RunAway(); else Shoot();`
3.  **小怪 3：持盾妖兵 (坦克)**
    * **机制**: 正面拥有 180 度 `Block` 判定。
    * **格挡逻辑**: 若悟空轻棍击中正面，触发 `Wukong::Recoil` (弹刀硬直)，且怪物不扣血。必须用重棍破盾或绕背。

### 3.2 Boss：妖王 (灵虚子/虎先锋)

**行为树逻辑 (Behavior Tree Structure):**

* **根节点 (Selector)**
    * **Condition**: HP < 50%? -> **Sequence (转阶段)**
        * 播放咆哮动画 -> 开启特效(红眼) -> 增加攻击力 -> 切换至二阶段技能库。
    * **Condition**: 距离 > 远距离? -> **Action**: 跳劈 (泰山压顶)。
    * **Condition**: 距离 < 近距离? -> **Selector (随机技能)**
        * Action: 爪击二连 (概率 60%)
        * Action: 咆哮控制 (概率 20%)
        * Action: 疯狗连咬 (概率 20%, 二阶段限定)

---

## 4. 💥 战斗核心：碰撞、音效与反馈 (Combat Feel)

### 4.1 碰撞系统 (Collision)
* **Hitbox (攻击框)**: 附着在武器骨骼上。仅在动作的 `Active Frames` (有效帧) 开启。
* **Hurtbox (受击框)**: 附着在角色模型上。
* **判定流程**:
    1.  检测 Hitbox 与 Hurtbox 重叠。
    2.  检测 Hurtbox 所有者是否处于无敌帧 (Invincible)。
    3.  检测是否格挡 (Shield Block)。
    4.  计算伤害 -> 扣血 -> 播放受击反馈。

### 4.2 音效反馈 (Audio Feedback) - 听觉打击感
* **挥空音效 (Whoosh)**: 攻击未命中时播放轻微的风声。
* **命中音效 (Hit)**: 击中肉体时播放沉闷的打击声。
* **暴击/重棍音效**: 击中时叠加高频的“铮”声。
* **格挡音效**: 金铁交加的清脆声。

### 4.3 视觉反馈 (Juice)
* **顿帧 (Hit Stop)**: 击中瞬间，`Director::getInstance()->pause()` 0.05~0.1 秒。表现“卡肉感”。
* **屏幕震动 (Screen Shake)**: 重棍或 Boss 技能命中时，摄像机沿 Y 轴随机抖动。
* **击退 (Knockback)**: 敌人根据受到的力，向后位移一段距离。
* **数字跳字**: 伤害数值从头顶飘出，暴击显示黄色大字体。

---

## 5. 🎒 系统与 UI 模块 (Systems)

* **装备**: 简化为单一武器（金箍棒）和单一防具（披挂）。
* **葫芦 (Gourd)**: 按键 `R` 使用。消耗 `current_sips`，恢复生命值。在土地庙（存档点）回满次数。
* **交互 (Interaction)**:
    * **饮酒**: 播放喝水动画，回血。
    * **调息 (Rest)**: 靠近土地庙按 `E`，播放打坐动画。**重置所有怪物位置，回满血蓝。**

### UI 布局 (HUD)
* **左下角**: [红条: 生命] [蓝条: 法力] [葫芦图标 xN]
* **左下角(动态)**: [黄条: 气力] (仅在消耗时显示，满时渐隐)
* **右下角**: [棍势槽: ⚪⚪⚪] (积累变亮) + [技能图标 (冷却遮罩)]

---

## 6. 📅 小组开发优先级建议 (Priority)

* **P0 (基建期 - 必须有)**:
    * 悟空移动、轻棍连招(无特效)、一个只会挨打的沙袋怪。
    * 基础碰撞检测、血条 UI 显示。
* **P1 (核心期 - 游戏性)**:
    * 加入**气力条**限制（跑两步就喘）。
    * 实现**重棍蓄力**和**棍势UI**。
    * 实现 Boss 的基础 AI (追击+普攻)。
    * 实现**定身法**。
* **P2 (打磨期 - 魂味)**:
    * 实现**完美闪避**的慢动作。
    * 加入**顿帧**、**震屏**和**音效**（这是手感的关键）。
    * Boss 转阶段逻辑和特效。